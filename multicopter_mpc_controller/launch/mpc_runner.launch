<launch>
  <!-- options -->
  <arg name="mav_name" default="hexacopter370" />
  <arg name="arm_name" default="flying_arm_3" />
  <arg name="arm_enable" default="false" />
  <arg name="trajectory_name" default="hover" />

  <arg name="trajectory_dt" default="20" />
  <arg name="trajectory_solver" default="SolverSbFDDP" />
  <arg name="trajectory_integration" default="IntegratedActionModelEuler" />

  <arg name="mpc_type" default="Carrot" />
  <arg name="use_internal_gains" default="false" />
  <arg name="motor_command_dt" default="4" />

  <arg name="groundtruth" default="false" />
  <arg name="disturbance_enable" default="false" />
  <arg name="disturbance_time" default="2.5" />

  <arg name="rosbag" default="true" />
  <arg name="record_solver" default="false" />

  <!-- parameters -->
  <arg name="trajectory_namespace" value="tg_$(arg trajectory_name)" />
  <arg name="trajectory_config" value="$(arg mav_name)_$(arg trajectory_name).yaml" unless="$(arg arm_enable)" />
  <arg name="trajectory_config" value="$(arg mav_name)_$(arg arm_name)_$(arg trajectory_name).yaml" if="$(arg arm_enable)" />

  <arg name="namespace_mpc" default="$(arg mpc_type)" />
  <arg name="mpc_config" value="$(arg mav_name)_mpc.yaml" unless="$(arg arm_enable)" />
  <arg name="mpc_config" value="$(arg mav_name)_$(arg arm_name)_mpc.yaml" if="$(arg arm_enable)" />

  <arg name="bag_file" value="$(find multicopter_mpc_bag)/rosbags/$(arg trajectory_name).bag" />

  <!-- simulator -->
  <include file="$(find multicopter_mpc_simulator)/launch/simulator.launch">
    <arg name="mav_name" value="$(arg mav_name)" />
    <arg name="world_name" default="basic" />
    <arg name="enable_logging" default="false" />
    <arg name="enable_ground_truth" default="true" />
    <arg name="log_file" default="$(arg mav_name)" />
    <arg name="debug" default="false" />
    <arg name="gazebo_gui" default="false" />
    <arg name="paused" default="false" />
    <arg name="arm_enable" default="$(arg arm_enable)" />
    <arg name="arm_name" default="$(arg arm_name)" />
    <arg name="disturbance_enable" default="$(arg disturbance_enable)" />
  </include>

  <group ns="$(arg namespace_mpc)">
    <param name="trajectory_config" value="$(find multicopter_mpc_yaml)/trajectories/$(arg trajectory_config)" />
    <param name="trajectory_dt" value="$(arg trajectory_dt)" />
    <param name="trajectory_solver" value="$(arg trajectory_solver)" />
    <param name="trajectory_integration" value="$(arg trajectory_integration)" />

    <param name="mpc_config" value="$(find multicopter_mpc_yaml)/mpc/$(arg mpc_config)" />
    <param name="mpc_type" value="$(arg mpc_type)" />

    <param name="use_internal_gains" value="$(arg use_internal_gains)" />
    <param name="record_solver" value="$(arg record_solver)" />
    <param name="motor_command_dt" value="$(arg motor_command_dt)" if="$(arg use_internal_gains)" />
    <param name="arm_name" value="$(arg arm_name)" if="$(arg arm_enable)" />

    <param name="disturbance_enable" value="$(arg disturbance_enable)" />
    <param name="disturbance_time" value="$(arg disturbance_time)" />

    <node name="$(arg mpc_type)" pkg="multicopter_mpc_controller" type="mpc_runner_node" output="screen">
      <remap from="/odometry" to="/$(arg mav_name)/ground_truth/odometry" if="$(arg groundtruth)" />
      <remap from="/odometry" to="/$(arg mav_name)/odometry_sensor1/odometry" unless="$(arg groundtruth)" />
      <remap from="/motor_command" to="/$(arg mav_name)/command/motor_speed" />
      <remap from="/joint_states" to="/$(arg mav_name)/joint_states" />
      <remap from="/joint_command_1" to="/$(arg mav_name)/joint1_effort_controller/command" if="$(arg arm_enable)" />
      <remap from="/joint_command_2" to="/$(arg mav_name)/joint2_effort_controller/command" if="$(arg arm_enable)" />
      <remap from="/joint_command_3" to="/$(arg mav_name)/joint3_effort_controller/command" if="$(arg arm_enable)" />
      <remap from="/disturbance_enable" to="/$(arg mav_name)/disturbance_enable" />
    </node>
  </group>

  <!-- Visualizer -->
  <include file="$(find multicopter_mpc_viz)/launch/trajectory_generator_viz.launch">
    <arg name="namespace" value="$(arg trajectory_namespace)" />
    <arg name="trajectory_config" value="$(arg trajectory_config)" />
    <arg name="launch_tools" value="false" />
  </include>

  <include file="$(find multicopter_mpc_controller)/launch/rviz.launch">
    <arg name="mav_name" value="$(arg mav_name)" />
  </include>


  <!-- auxiliary nodes -->
  <node pkg="rqt_reconfigure" type="rqt_reconfigure" name="$(arg mpc_type)_rqt_reconfigure" />
  <!-- <node name="record_node" pkg="rosbag" type="record" args="record -o $(arg bag_file) -a" if="$(arg rosbag)"/> -->
</launch>